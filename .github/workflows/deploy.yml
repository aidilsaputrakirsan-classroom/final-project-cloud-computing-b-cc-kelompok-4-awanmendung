name: ğŸš€ Auto Deploy ke STB

on:
  push:
    branches:
      - development

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§° Install zip utility
        run: sudo apt-get install zip -y

      - name: ğŸ“ Buat file ZIP untuk deploy
        run: |
          zip -r deploy.zip . -x ".git*" -x ".github*" -x "node_modules/*"

      - name: ğŸš€ Upload ke STB Server
        id: deploy
        env:
          REPO_NAME: ${{ github.repository }}   # contoh: aidil/project
        run: |
          echo "ğŸš€ Uploading $REPO_NAME..."

          echo "ğŸ“‚ Cek deploy.zip:"
          ls -lh deploy.zip || echo "deploy.zip TIDAK ADA!"

          if [ ! -f deploy.zip ]; then
            echo "âŒ deploy.zip tidak ditemukan. Deploy dihentikan."
            exit 1
          fi

          RESPONSE=$(curl -s -S -k -m 60 --connect-timeout 10 \
            -X POST \
            -F "repo=$REPO_NAME" \
            -F "file=@deploy.zip;type=application/zip" \
            "https://deploy.akhzafachrozy.my.id/")

          echo "ğŸ’¬ Respons server:"
          echo "$RESPONSE"

          PORT=$(echo "$RESPONSE" | grep -oP '(?<=Port:\s)\d+')

          if [ -z "$PORT" ]; then
            echo "âš  Port tidak terdeteksi!"
          else
            echo "ğŸŒ Aplikasi berjalan di port: $PORT"
            echo "port=$PORT" >> $GITHUB_OUTPUT
          fi

      - name: âœ… Selesai
        run: |
          echo "ğŸ‰ Deploy selesai!"
          echo "ğŸ”— Log server: /var/log/autodeploy_${{ github.event.repository.name }}.log"
          echo "ğŸŒ Port aktif: ${{ steps.deploy.outputs.port }}"
